<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mycompany.webapp.dao.OrderDAO">
	<!-- 주문 목록 페이지 불러오기 -->
	<resultMap id="OrderListResult" type="orderList">
	    <result property="porderno" column="PORDERNO"/>
	    <result property="porderdate" column="PORDERDATE"/>
	    <collection property="orderItems" column="PORDERNO" javaType="java.util.ArrayList" ofType="orderItem" select="getOrderItem"/>
	</resultMap>

	<!-- 주문 목록 페이징 처리(진행중) -->
	<select id="getOrderListByPage" resultMap="OrderListResult">
		SELECT rnum, porderno, porderdate
		FROM (
		SELECT ROWNUM AS rnum, porderno, porderdate
			FROM (
				SELECT porderno, porderdate
				FROM productorder
				WHERE mno = #{mno}
				ORDER BY porderdate DESC
			)
		WHERE ROWNUM &lt;= #{pager.endRowNo}  <!-- endRowNo -->
		)
		WHERE rnum &gt;= #{pager.startRowNo} <!-- startRowNo -->

	</select>
	
	<!-- 주문 목록 갯수 가져오기(유저번호) -->
	<select id="getOrderListCount" resultType="int" parameterType="int">
		SELECT COUNT(*) FROM productorder WHERE mno = #{mno}
	</select>
	
	<!-- 주문 목록, 상세 페이지 주문상품아이템 -->
	<select id="getOrderItem" resultType="orderItem">
		SELECT pod.podno, pod.porderno, pod.pcode, pod.pcolor, pod.psize, pod.podprice, pod.podamount, pod.podstatus, pimg.imgurl1, p.pbrand, p.pname, p.pprice
		FROM porderdetail pod, productimg pimg, product p
		WHERE pod.porderno = #{porderno} AND pod.pcode = pimg.pcode AND pod.pcode = p.pcode
	</select>
	
	<!-- 주문상세페이지 불러오기  -->	
	<resultMap id="OrderDetailResult" type="orderDetail">
	    <result property="porderno" column="PORDERNO"/>
	    <result property="mno" column="MNO"/>
	    <result property="pordermphone" column="PORDERMPHONE"/>
	    <result property="pordername" column="PORDERNAME"/>
	    <result property="porderphone" column="PORDERPHONE"/>
	    <result property="porderaddr1" column="PORDERADDR1"/>
	    <result property="porderaddr2" column="PORDERADDR2"/>
	    <result property="porderaddr3" column="PORDERADDR3"/>
	    <result property="pordertel" column="PORDERTEL"/>
	    <result property="porderrequest" column="PORDERREQUEST"/>
	    <result property="porderemail" column="PORDEREMAIL"/>
	    <result property="pordertotalorgprice" column="PORDERTOTALORGPRICE"/>
	    <result property="porderdiscount" column="PORDERDISCOUNT"/>
	    <result property="porderpayprice" column="PORDERPAYPRICE"/>
	    <result property="pordertotalpoint" column="PORDERTOTALPOINT"/>
	    <result property="porderdate" column="PORDERDATE"/>
	    <result property="porderdonedate" column="PORDERDONEDATE"/>
	    <result property="porderpayment" column="PORDERPAYMENT"/>
	    <result property="porderpayname" column="PORDERPAYNAME"/>
	    <result property="porderpayno" column="PORDERPAYNO"/>
	    <collection property="orderItems" column="PORDERNO" javaType="java.util.ArrayList" ofType="orderItem" select="getOrderItem"/>
	</resultMap>
	
	<select id="getOrderDetail" resultMap="OrderDetailResult" parameterType="int">
		SELECT porderno, mno, pordermphone, pordername, porderphone,
		 porderaddr1, porderaddr2, porderaddr3, pordertel,
		 porderrequest, porderemail, pordertotalorgprice,
		 porderdiscount, porderpayprice, pordertotalpoint,
		 porderdate, porderdonedate, porderpayment,
		 porderpayname, porderpayno, porderpayinstallment
		FROM productorder
		WHERE mno = #{param1} AND porderno = #{param2}
	</select>
	
	<insert id="createOrder" parameterType="productOrder">
		<selectKey keyProperty="porderno" resultType="int" order="BEFORE">
    		SELECT SEQ_PORDERNO.NEXTVAL FROM DUAL
  		</selectKey>
	
		INSERT INTO productorder VALUES(#{porderno}, #{mno}, #{pordermphone},#{pordername},#{porderphone},#{porderaddr1},
		#{porderaddr2},#{porderaddr3},#{pordertel},#{porderrequest},#{porderemail},#{pordertotalorgprice},#{porderdiscount},#{porderpayprice}
		,#{pordertotalpoint},SYSDATE,null,#{porderpayment},#{porderpayname},#{porderpayno},#{porderpayinstallment})
	
	</insert>
</mapper>