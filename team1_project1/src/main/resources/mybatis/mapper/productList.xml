<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany.webapp.dao.ProductListDAO">
	
	<select id="selectByCategoryPage" resultMap="productListResultMap" parameterType="pager">
		SELECT RNUM, CCODE, PCODE, PNAME, PBRAND, PPRICE, PDATE, ENABLED, PCOLOR, IMGURL1, IMGURL2, IMGURL3, COLORURL
		FROM(
			SELECT ROWNUM AS RNUM, CCODE, PCODE, PNAME, PBRAND, PPRICE, PDATE, ENABLED, PCOLOR, IMGURL1, IMGURL2, IMGURL3, COLORURL
			FROM (
				SELECT PCA.CCODE AS CCODE,
				PCA.PCODE AS PCODE,
				PROD.PNAME AS PNAME, 
				PROD.PBRAND AS PBRAND, 
				PROD.PPRICE AS PPRICE, 
				PROD.PDATE AS PDATE, 
				PROD.ENABLED AS ENABLED,
				PRODIMG.PCOLOR AS PCOLOR, 
				PRODIMG.IMGURL1 AS IMGURL1, 
				PRODIMG.IMGURL2 AS IMGURL2, 
				PRODIMG.IMGURL3 AS IMGURL3, 
				PRODIMG.COLORURL AS COLORURL
			    FROM PCATEGORY PCA 
			    JOIN PRODUCT PROD ON PCA.PCODE = PROD.PCODE 
			    JOIN PRODUCTIMG PRODIMG ON PROD.PCODE = PRODIMG.PCODE
			    WHERE CCODE LIKE #{ccode}||'%'
			    ORDER BY ENABLED
			)
			WHERE ROWNUM &lt;= #{endRowNo}
		)
		WHERE RNUM &gt;= #{startRowNo}

	</select>

	<resultMap id="productListResultMap" type="productList">
		<result property="pno" column="RNUM"/>
		<result property="ccode" column="CCODE"/>
		<result property="pcode" column="PCODE"/>
		<result property="pname" column="PNAME"/>
		<result property="pbrand" column="PBRAND"/>
		<result property="pprice" column="PPRICE"/>
		<result property="pdate" column="PDATE"/>
		<result property="enabled" column="ENABLED"/>
		<collection property="color" ofType="productImg">
			<id property="pcolor" column="PCOLOR"/>
			<result property="pcode" column="PCODE"/>
			<result property="imgurl1" column="IMGURL1"/>
			<result property="imgurl2" column="IMGURL2"/>
			<result property="imgurl3" column="IMGURL3"/> 
			<result property="colorurl" column="COLORURL"/> 
		</collection>
	</resultMap>
	
	<select id="productListCount" resultType="int">
		SELECT COUNT(*) FROM PCATEGORY WHERE CCODE=#{ccode}||'%'
	</select>
</mapper>